# diy-ventilation-controller
DIY-контроллер приточной вентиляции на базе контроллера ESP32/8266 и проектов ESPHome и Home Assistant.

I.	Аннотация
Данный программный код контроллера приточной системы вентиляции разработан для автоматического управления скоростью оборотов приточного вентилятора в зависимости от внешних датчиков температуры и CO2, подключенных как локально, так и удаленно.

II.	Описание программной части
Программным «фреймворком» для разработки, компиляции и прошивки является открытая платформа ESPHome. Данный программный код представляет из себя конфигурацию для проекта ESPHome и реализует всю необходимую логику работы контроллера.
Данный программный код разрабатывался для совместной работы в программной инфраструктуре открытой операционной системы умного дома Home Assistant и весь функционал контроллера вентиляции будет доступен только при использовании его вместе с сервером умного дома на базе операционной системы Home Assistant. Тем не менее, контроллер поддерживает полностью автономную работу, но с ограниченной функциональностью.

III.	Описание аппаратной части
Для работы программного кода возможно использовать любой контроллер, поддерживаемый платформой ESPHome. Рекомендуется использовать ESP32 или ESP8266. Оригинальный код разрабатывался для работы с контроллером ESP32.
Так как система вентиляции представляет из себя комплексный набор устройств, ниже будет приведен перечень дополнительных электронных и электрических устройств, необходимых для работы приточной установки. Оригинальный код контроллера и его функционал разрабатывался с учетом этого конкретного набора компонентов:

1. Приточный вентилятор ERA Typhoon 160 2SP – канальный вентилятор с AC-двигателем, имеющий две обмотки мотора, которые реализовывают две «аппаратных» ступени расхода воздуха;
2. Регулятор скорости вентилятора Сityron CTY-1.8 – контроллер, позволяющий изменять переменное напряжение от 0 до 230 вольт, сохраняя при этом чистую синусоидальную форму переменного тока. Важной особенностью данного контроллера является управляющий вход 0-10 вольт, который позволяет менять выходное переменное напряжение в зависимости от поданного на управляющий вход;
3. Конвертер ШИМ-сигнала PW1VA01 – преобразовывает ШИМ-сигнал в напряжение 0-10 вольт в зависимости от частоты импульсов ШИМ;
4. Плата ESP32 WROOM – основной контроллер, обеспечивающий получение данных с датчиков, вычисление необходимой скорости работы и передачу управляющего сигнала на вентилятор, реле и другие возможные устройства;
5. Датчик температуры Dallas DS18B20 – основной температурный датчик, устанавливаемый в приточный канал и предназначенный для измерения температуры входящего (поступающего) уличного воздуха
6. OLED-дисплей SSD1306 – необходим для индикации основных параметров работы контроллера;
7. Кнопка без фиксации – служит для активации дисплея на определенный период времени;
8. Датчик углекислого газа (CO2) Sensirion SCD40 (или SCD41) – датчик, используемый для измерения уровня CO2 в вентилируемом помещении. Ключевой элемент обратной связи для логики управления скоростью работы вентилятора. В данном проекте, реализовано удаленное подключение датчика CO2. Он подключен и передает показания в Home Assistant через дополнительную плату ESP8266, а данный контроллер вентиляции получает данные этого датчика через Home Assistant, а не напрямую. Тем не менее, возможно легко модифицировать код контроллера для локального подключения датчика если такое возможно и таким образом существенно улучшить автономность системы;
9. Релейный модуль с опторазвязкой одноканальный – опциональный компонент. Служит для переключения обмоток вентилятора ERA Typhoon 160 2SP что расширяет диапазона возможностей регулировки расхода воздуха и уровня шума;
10. Датчик дыма MQ-2 – опциональный компонент. Устанавливается в приточный канал вместе с датчиком температуры и служит для определения наличия дыма в приточном канале и своевременном отключении вентиляции. Появление данного датчика в логике работы системы обусловлено частым сжиганием костров в весенне-осенний период в местности проживания автора. Возможна замена датчика на другие, более актуальные, например датчики VOC, в зависимости от ваших потребностей. При этом код потребует минимальных изменений. Так же возможно использовать версию кода без логики аварийного отключения;
11. Датчик влажности и температуры SHT40/41 – опциональный компонент. Датчик устанавливается в приточный канал. Служит для определения уровня влажности, что может быть полезно в зимний период. В логике работы в текущей версии кода не участвует и в конфигурации не прописан. Так же возможно зарезервировать показания температуры на случай отказа основного датчика (в текущем коде не реализовано).

IV. Дополнительное оборудование, планируемое к реализации в будущих версиях
1.	Датчик тока и напряжения PZEM-004 – предназначен для мониторинга переменного напряжения и потребляемого тока. Планируется к установке два датчика: 
- первый, для мониторинга тока и текущего напряжения вентиляторов. Это поможет лучше отслеживать ситуацию фактической работы вентилятора и обнаружения возможных сбоев в работе контроллера Сityron CTY-1.8;
- второй, для мониторинга потребляемого тока и напряжения канального нагревателя.
  Установка двух датчиков необязательна. Но установка одного общего датчика тока и напряжения PZEM-004 необходима для расчета потребляемой энергии, который потребуется для будущей логики работы канального подогревателя;
2.	Канальный нагреватель на PTC-элементе – устанавливается в приточный канал. PTC-элемент обеспечивает динамический нагрев с изменяемым током, а так же улучшает пожаробезопасность;
3.	Термостат для канального нагревателя, с возможностью удаленной установки температуры. Рассматривается REX C-100 (но он не совсем соответствует требованиям), а также включение термостата в логику работы основного контроллера - ВОПРОС ОТКРЫТЫЙ.
4.	Датчик температуры Dallas DS18B20 – температурный датчик, устанавливаемый в приточный канал после нагревателя и предназначенный для измерения температуры непосредственно приточного воздуха (поступающего в помещение) и используемый для вычисления дельты температуры нагрева.

V.	Основная логика работы контроллера приточной вентиляции
Данный код контроллера приточной вентиляции основан на принципе поддержания необходимого уровня CO2 в помещении. Параметр уровня CO2 является основным ориентиром для определения необходимой скорости работы вентилятора и, соответственно, регулировки расхода воздуха. В тоже время, постоянное поддержание оптимального уровня CO2, особенно в зимний период, приводит к неоправданно высокому расходу электрической энергии (в случае наличия электрического канального подогревателя) или высокому уровню дискомфорта (в случае его отсутствия).
В связи с этим, в основной логике контроллера было реализовано компромиссное решение – ограничение скорости работы вентилятора (и соответственно расхода воздуха) в зависимости от температуры приточного воздуха. Это позволяет установить предельную скорость работы вентилятора для экономии электричества зимой или, в случае отсутствия канального подогревателя, – уменьшения сквозняков и холодных потоков воздуха до комфортного уровня. Определение предельной скорости предполагается с помощью настройки температурной кривой лимита скоростей вентилятора. Температурная кривая реализована в коде контроллера в виде семи точек от 0 до 30 градусов с шагом 5 градусов. Данные точки доступны в Home Assistant через API и предполагают установку предельной скорости (от 0% до 100%) с дальнейшей автоматической экстраполяцией по всему температурному диапазону. 
 
В коде контроллера реализован виртуальный сенсор температурного лимита скорости, который рассчитывает предельную скорость вентилятора в зависимости от текущей температуры входящего воздуха. Предполагается, что пользователь опытным путем настроит необходимые ему предельные скорости работы вентилятора под свою конкретную модель вентилятора, площадь и планировку вентилируемого помещения.
Параллельно с вычислением лимита скорости по температуре поступающего воздуха, контроллер вычисляет необходимую скорость работы по данным датчика CO2. Для этого реализована установка целевого уровня CO2 в помещении. Используя данные текущего уровня CO2 и установленного значения целевого уровня, контроллер линейно увеличивает скорость, пропорционально уровню превышения фактического значения CO2 над целевым. Для удобства, реализован настраиваемый порог целевого уровня CO2 в помещении, доступный для настройки из Home Assistant.
 
Итоговая скорость определяется наименьшим значением. Таким образом, лимит скорости по температуре всегда имеет приоритет над требуемой скоростью по датчику CO2. Это позволяет не только ограничивать расход воздуха в холодный период, но и снижать скорость вентилятора вплоть до полного его отключения, когда уровень CO2 в доме достигает заданной (как правило в случае отсутствия людей в вентилируемом помещении). Преимуществом данного алгоритма является простота настойки и оптимальная работа, которая позволяет поддерживать достаточно комфортный уровень CO2, достигая при этом максимальной энергоэффективности и не принося дискомфорта от излишних потоков холодного воздуха.

VI.	Логика управления контроллером
В контроллере реализовано 3 основных режима работы: автоматический, ручной и полуавтоматический.
 
1.	Автоматический режим. Работает на основной логике, описанной в разделе V. Дополнительно интегрирована возможность автоматического переключения обмоток вентилятора ERA Typhoon 160 2SP, расширяющая диапазон расхода воздуха вентилятора. Пользователю доступна настройка порога переключения обмоток от 0 до 30 градусов. Для исключения «дребезга» применяется гистерезис в 1 градус.
 
Кроме этого, в алгоритм определения итоговой скорости включена коррекция скорости с динамическим коэффициентом 1.4 при переключении обмоток, для исключения резкого перепада расхода воздуха. При использовании других вентиляторов данную логику необходимо изменить или удалить.
Данный режим является основным, он выбирается при загрузке контроллера, а также контроллер переходит в него при любых нештатных ситуациях.
2.	Ручной режим. Позволяет вручную устанавливать скорость, а также включать, выключать вентилятор и переключать его обмотку (если доступно) на неопределенное время, пока есть связь с Home Assistant. Данная возможность представлена штатным компонентом «fan» платформы ESPHome. Реализована синхронизация скоростей и состояния данного компонента с фактической скоростью и состоянием в других режимах.
3.	Полуавтоматический режим. Устанавливает заданную пользователем скорость на определенное им время. Настройка скорости и времени доступна из Home Assistant. Параметры применяются при выборе Полуавтоматического режима работы.
 
Контроллер позволяет использовать установку скорости от 0 до 100% на время от 1 до 600 минут (можно легко расширить или уменьшить диапазоны в коде). Таким образом этот режим предоставляет пользователю возможность приостановить работу вентиляции или включить режим интенсивного проветривания на определенное время. После истечения времени контроллер перейдет в автоматический режим работы.

VII.	Вспомогательная логика работы контроллера приточной вентиляции
В связи с тем, что код контроллера разрабатывался под конкретные комплектующие, перечисленные в разделе III, потребовалась реализация дополнительной логики для обеспечения их работы:
1.	Преобразование диапазона управляющего напряжения из 0 – 10 вольт в 1 – 10 вольт. Связано с особенностью работы регулятора оборотов Сityron CTY-1.8. Данный контроллер перестает подавать переменный ток при управляющем напряжение ниже 1 вольта. В связи с этим, в основном программном выходе реализовано соответствующее масштабирование напряжения, которое применяется на финальном этапе установки скорости: 0% - 0V, 1% - 1.1V, 100% - 10V.
2.	Разгон вентилятора (speedup). Вентилятор ERA Typhoon 2SP 160 корректно работает с регулятором оборотов Сityron CTY-1.8 при напряжении выше 100 вольт (около 15% скорости). Если вентилятор остановлен, напряжение ниже 100 вольт может не запустить его. При этом уже запущенный вентилятор корректно работает с низким напряжением, обеспечивая минимальный расход воздуха.
Так как логика работы контроллера предполагает его запуск с низких скоростей (5% и выше) для гарантированного запуска вентилятора реализована логика разгона (speedup) в коде виртуального выхода (template output). При каждом запуске вентилятора скриптом активируется защитный период на 10 секунд. Если сразу при включении или в течении времени защитного периода была попытка установки скорости ниже 15% - автоматически активируется вспомогательный режим speedup. В режиме speedup скорость принудительно устанавливается на 15% на 10 секунд игнорируя в течении этого времени любые другие запросы скоростей в любых режимах. По истечении 10 секунд контроллер устанавливает последнюю запрошенную скорость и продолжает работу в текущем основном режиме (автоматическом, ручном или полуавтоматическом).
Данная логика гарантирует стабильный запуск приточного вентилятора с любых скоростей и должна быть полезна не только для конкретной модели ERA Typhoon 160 2SP, но и для других моделей вентиляторов после корректировки продолжительности и скорости в режиме разгона.
Ручных настроек режима разгона в контроллере не предусмотрено, так как ожидается что это системная логика, которая работает постоянно в жестко заданном режиме под конкретную модель вентилятора. Но при необходимости ее можно достаточно просто изменить или удалить из основного template выхода.

VIII.	Аварийный режим работы
В контроллере предусмотрен аварийный режим для остановки вентиляции в случае неприемлемых показателей поступающего воздуха. В конкретном коде используется параметр концентрации дыма, отслеживаемый датчиком дыма MQ-2. Можно достаточно просто перепрофилировать режим под другой датчик, отслеживающий другие параметры или не использовать данный функционал. 
В оригинальной версии датчик MQ-2 передает уровень задымления в процентах. Так как аналоговый датчик требует точной калибровки и настройки под конкретные условия работы, реализован порог сработки аварийного режима, доступный для настройки из интерфейса Home Assistant.
 
При сработке предусмотрен гистерезис 10% - аварийный режим отменится после снижения уровня задымления на 10% ниже заданного. Для более эффективного отслеживания уровня дыма (или других соединений) в приточном канале после остановки вентиляции, предусмотрен режим периодической активации вентилятора с текущей скоростью автоматического режима каждые 20 минут на 30 секунд. Это позволяет эффективно обновить воздух в приточном канале и получить актуальные данные уровня загрязнения. Настроек периодичности и времени в Home Assistant не предусмотрено, так как это считается системный режимом, но их можно легко отредактировать напрямую в коде при необходимости.
Важно отметить, что данный режим работает только при активном Автоматическом режиме. Если до наступления события задымления были активны другие режимы (не относится к Разгону), то при активации аварийного режима автоматически активируется Авторежим и вентиляция отключится с периодическим проветриванием датчика. При этом в аварийном режиме у пользователя сохраняется возможность вручную установить Полуавтоматический или Ручной режим с любой установкой скорости, на любое время или снова включить Авторежим. Логика аварийного режима продолжит работу, а в основном статусе работы контроллера отображение состояния Задымления останется в любом режиме, пока не произойдет автоматическая отмена по достижении нужных показателей качества воздуха. 
Так как сенсор MQ-2 требует качественной калибровки и отладки, для быстрого отключения аварийного режима предполагается установка порога в 100%. При этом сенсор MQ-2 ограничен показаниями 90%, таким образом при таком параметре аварийный режим никогда не будет активирован или немедленно отключится в случае неправильной активации. Так же необходимо обратить внимание на подключение MQ-2 к ESP32. Оптимальная точность работы достигается при питании датчика от 5 вольт. При этом необходимо подключать сигнальные провода к ESP через делитель, для согласования логических уровней 5В в 3.3В.

IX.	Подробная инструкция по сборке контроллера содержится в папке docs.

X.	Дополнительная информация

Отказ от ответственности:
Данный проект системы вентиляции на базе ESPHome предоставляется и распространяется по принципу «как есть» (as-is), без каких-либо явных или подразумеваемых гарантий. Автор не гарантирует корректность работы, безопасность или пригодность решения для конкретных условий эксплуатации.
Использование материалов проекта осуществляется на ваш собственный риск. Вы самостоятельно несете ответственность за любые последствия, включая возможный ущерб оборудованию, имуществу или здоровью, возникшие в результате применения предложенных решений. Перед внедрением системы настоятельно рекомендуется:
•	провести аудит кода на соответствие стандартам безопасности;
•	протестировать решение в контролируемых условиях;
•	убедиться в соблюдении норм и правил эксплуатации инженерных систем.

Участие сообщества:
Автор приветствует любой вклад в развитие проекта, а также публикацию кода на площадке GitHub для совместного исправления ошибок, оптимизации кода, и реализации новых идей.

Благодарю за интерес к проекту!
