# ESP32 DIY Ventilation Controller
DIY-контроллер приточной вентиляции на базе контроллера ESP32/8266 и проектов ESPHome и Home Assistant.

I.	Аннотация.

Данный программный код контроллера приточной системы вентиляции разработан для автоматического управления скоростью приточного вентилятора и температурой электрического нагревателя в зависимости от внешних датчиков температуры и CO2, подключенных как локально, так и удаленно.

II.	Описание программной части.

Программным «фреймворком» для разработки, компиляции и прошивки является открытая платформа ESPHome. Данный программный код представляет из себя конфигурацию для проекта ESPHome и реализует всю необходимую логику работы контроллера.
Данный программный код разрабатывался для совместной работы в программной инфраструктуре открытой операционной системы умного дома Home Assistant и весь функционал контроллера вентиляции будет доступен только при использовании его вместе с сервером умного дома на базе операционной системы Home Assistant. Тем не менее, контроллер поддерживает полностью автономную работу, но с ограниченной функциональностью.

III.	Описание аппаратной части.

Для работы программного кода возможно использовать любой контроллер, поддерживаемый платформой ESPHome. Рекомендуется использовать ESP32 или ESP8266. Оригинальный код разрабатывался для работы с контроллером ESP32.
Так как система вентиляции представляет из себя комплексный набор устройств, ниже будет приведен перечень дополнительных электронных и электрических устройств, необходимых для работы приточной установки. Оригинальный код контроллера и его функционал разрабатывался с учетом этого конкретного набора компонентов:

1. Приточный EC-вентилятор, управляемый сигналом PWM или 0-10В c выводом тахометра (необязательно) – канальный вентилятор с DC-двигателем, имеющий встроенный электронный контроллер управления скоростью, предпочтительно с датчиком оборотов (тахометром), например Dastech HDD/HF-xxxPE или Sensdar SE-Axxx E-01;
2. Конвертер ШИМ-сигнала PW1VA01 (при необходимости) – преобразовывает ШИМ-сигнал в напряжение 0-10 вольт в зависимости от частоты импульсов ШИМ. Необходим, если вы подключаете управляющий сигнал через 0-10В;
3. PTC-нагреватель, управляемый через SS-реле (SSR) – нагревательный элемент в корпусе с электроникой, обычно SSR с термостатами защиты от перегрева (например, Naveka PTC 1.9A) под ваш диаметр воздуховодов;
4. Плата ESP32 WROOM (2 шт.) – установлена в основной контроллер, обеспечивающий получение данных с датчиков, вычисление необходимой скорости работы и передачу управляющего сигнала на вентилятор, реле и нагреватель; а так же в качестве дополнительной платы, играющей роль локального контроллера нагревателя;
5. Датчики температуры Dallas DS18B20 (2 шт.) – основные температурные датчики, устанавливаемые в приточный канал до и после нагревателя и предназначенный для измерения температуры входящего (поступающего) уличного воздуха и нагретого приточного воздуха;
6. OLED-дисплей SSD1306 (2 шт.) – необходим для индикации основных параметров работы контроллера; опционально устанавливается и в нагреватель;
7. Кнопка без фиксации (2 шт.) – служит для активации дисплея на определенный период времени; опционально устанавливается и в нагреватель;
8. Конвертер TTL в RS485 на базе чипа XY-017 (2 шт.) – служит для преобразования UART-интерфейса ESP32 в Modbus-интерфейс. Необходим для соединения контроллера нагревателя с основным контроллером вентиляции на большом расстоянии (несколько метров и больше);
9. AC-DC блок питания 5В 2A – необходим для питания контроллера нагревателя, датчика температуры и других устройств в нем;
10. Датчик углекислого газа (CO2) Sensirion SCD40 (или SCD41) – датчик, используемый для измерения уровня CO2 в вентилируемом помещении. Ключевой элемент обратной связи для логики управления скоростью работы вентилятора. В данном проекте, реализовано удаленное подключение датчика CO2. Он подключен и передает показания в Home Assistant через дополнительную плату ESP8266, а данный контроллер вентиляции получает данные этого датчика через Home Assistant, а не напрямую. Тем не менее, возможно легко модифицировать код контроллера для локального подключения датчика если такое необходимо (с помощью дополнительных конвертеров XY-017) и таким образом создать полностью автономную систему, независимую от Wi-Fi доступности сервера HA;
11. Релейный модуль с опторазвязкой двухканальный – опциональный компонент. Служит для коммутации секций PTC-элемента нагревателя. Помогает оптимизировать нагрев в условиях разной температуры и расхода воздуха;
12. Энергетический датчик PZEM-004T (v.3.0, лучше 4.0) – опциональный компонент. Служит для мониторинга потребления электроэнергии нагревателем, что позволяет активировать функционал ограничения потребления энергии приточной системой вентиляции;
10. Датчик дыма MQ-2 – опциональный компонент. Устанавливается в приточный канал вместе с датчиком температуры и служит для определения наличия дыма в приточном канале и своевременном отключении вентиляции. Появление данного датчика в логике работы системы обусловлено частым сжиганием костров в весенне-осенний период в местности проживания автора. Возможна замена датчика на другие, более актуальные, например датчики VOC, в зависимости от ваших потребностей. При этом код потребует минимальных изменений. Так же возможно использовать версию кода без логики аварийного отключения;
11. Датчик влажности и температуры SHT40/41 – опциональный компонент. Датчик устанавливается в приточный канал. Служит для определения уровня влажности, что может быть полезно в зимний период. В логике работы в текущей версии кода не участвует и в конфигурации не прописан. Так же возможно зарезервировать показания температуры на случай отказа основного датчика (в текущем коде не реализовано).
Принципы и общая схема работы приточной системы

IV. Принципы и общая схема работы приточной системы

1.	Основными принципами проекта являются: автономность, отказоустойчивость, простота настройки и предсказуемость работы приточной системы. Несмотря на кажущуюся сложность, регулировка уже настроенной системы вентиляции сводится лишь к нескольким параметрам: желаемой температуре, CO2 и потребляемого электричества.
2.	Аппаратно приточная система разделена на два контроллера: контроллер вентиляции (основной) и контроллер нагревателя (вспомогательный). Несмотря на то, что технически возможно все реализовать в одном контроллере, на практике правильнее будет разделить перемещение и нагрев воздуха по следующим причинам:
- Сложность кода: суммарно код двух контроллеров содержит более 3 тысяч строк кода конфигурации yaml;
- Сложность коммутации: дополнительная проводка к реле и датчикам нагревателя от основного контроллера затруднит монтаж;
- Теплопотери: основная причина разделения нагревателя и вентилятора.
Важно понимать, что текущая архитектура приточной системы вентиляции создавалась в контексте конкретного места установки, а именно: неотапливаемый чердак частного жилого дома. В связи с тем, что вентканалы проходят по чердаку, присутствуют ощутимые теплопотери несмотря на утепление (приблизительно 0,2-0,5 градуса на метр воздуховода). Для их минимизации оптимальна установка электрического нагревателя непосредственно перед разделением основной магистрали на ветки (в идеале, перед камерой статического давления). Установка вентилятора напротив, рекомендуется как можно дальше от вентиляционных выходов в доме, для минимизации уровня шума и вибраций. 
Таким образом, расстояние между вентилятором и нагревателем в случае автора составило около 10 метров и сделало целесообразным разделение приточного вентилятора и электрического нагревателя.
В случае установки системы над натяжным или каркасным потолком или других отапливаемых местах возможно целесообразнее объединить контроллеры вентиляции и нагревателя.

V.	Основная логика работы контроллера приточной вентиляции

Данный код контроллера приточной вентиляции основан на принципе поддержания необходимого уровня CO2 в помещении. Параметр уровня CO2 является основным ориентиром для определения необходимой скорости работы вентилятора и, соответственно, регулировки расхода воздуха и его нагрева в случае необходимости. В тоже время, постоянное поддержание оптимального уровня CO2, особенно в зимний период, приводит к неоправданно высокому расходу электрической энергии (в случае наличия электрического канального подогревателя) или высокому уровню дискомфорта (в случае его отсутствия).
В связи с этим, в основной логике контроллера были реализовано компромиссное решение – ограничение скорости работы вентилятора (и соответственно расхода воздуха) в зависимости от температуры поступающего воздуха и потребленной электроэнергии (опционально). Это позволяет установить лимит потребляемого электричества для экономии зимой или, в случае отсутствия канального подогревателя, – уменьшения сквозняков и холодных потоков воздуха до комфортного уровня. 
Итоговая скорость вентилятора формируется из целевого значения, рассчитанного по датчику CO2 и ограничивается двумя ступенями: бюджетом энергии и температурой приточного воздуха. Обе ступени можно отключить или настроить таким образом, чтобы они не ограничивали скорость, рассчитанную по датчику CO2.

1.	Ограничитель по лимиту энергии
Со стороны пользователя, для активации бюджета энергии необходимо установить лимит электричества на сутки в Вт*ч (например, 10000 это 10 кВт) и активировать соответствующий переключатель. Данные сущности доступны в Home Assistant через API. Так же необходим подключенный счетчик энергии от датчика PZEM-004T. В коде контроллера реализован виртуальный сенсор энергетического лимита скорости, который рассчитывает текущий rate расхода энергии и на основе PI-регулятора формирует предельную скорость вентилятора в зависимости от доступного остатка энергии. Если функция лимита по энергии активна, то итоговая скорость вентилятора ограничивается в соответствии с лимитом. Это приводит к недостатку воздухообмена и некоторому росту CO2. Предполагается что пользователь сам настроит под себя необходимый баланс потребления электричества и концентрации CO2.
Стоит отметить, что расчет скорости по лимиту энергии сильно зависит от физических характеристик нагревателя и вентилятора и может потребовать подстройки PI-коэффициентов под конкретное оборудование.

2.	Ограничитель по температуре воздуха
Определение предельной скорости предполагается с помощью настройки температурной кривой лимита скоростей вентилятора. Температурная кривая реализована в коде контроллера в виде семи точек от 0 до 30 градусов с шагом 5 градусов. Данные точки доступны в Home Assistant через API и предполагают установку предельной скорости (от 0% до 100%) с дальнейшей автоматической экстраполяцией по всему температурному диапазону. 
В коде контроллера реализован виртуальный сенсор температурного лимита скорости, который рассчитывает предельную скорость вентилятора в зависимости от текущей температуры входящего воздуха. Предполагается, что пользователь опытным путем настроит необходимые ему предельные скорости работы вентилятора под свою конкретную модель вентилятора, площадь и планировку вентилируемого помещения.

3.	Целевая скорость по датчику CO2
Параллельно с вычислением лимитов скорости по потребленной энергии и температуре поступающего воздуха, контроллер вычисляет необходимую скорость работы по данным датчика CO2. Для этого реализована установка целевого уровня CO2 в помещении. Используя данные текущего уровня CO2 и установленного значения целевого уровня, контроллер линейно увеличивает скорость, пропорционально уровню превышения фактического значения CO2 над целевым. Для удобства, реализован настраиваемый порог целевого уровня CO2 в помещении, доступный для настройки из Home Assistant.

4.	Формирование итоговой скорости
Итоговая скорость определяется наименьшим значением из трех вычисленных скоростей: лимита энергии, температурных ограничений и требования CO2. Если активатор лимита энергии неактивен, используются две скорости (температурный лимит и требования CO2). Таким образом, если лимит скорости по доступной энергии включен, то он имеет приоритет над требуемой скоростью по датчику CO2, но одновременно с этим лимит скорости по температуре активен всегда и имеет высший приоритет. 

5.	Дополнительные особенности работы алгоритма
В системах с установленным электрическим нагревателем (по умолчанию в данной конфигурации) контроллер обладает данными с двух температурных датчиков: до и после нагревателя. Основным является датчик после нагревателя. С ним по умолчанию работает PID-алгоритм нагревателя, а также виртуальный датчик расчета скорости по лимиту температуры. Таким образом, в случае отказа нагревателя, скорость вентилятора будет автоматически регулироваться согласно температурному лимиту.
Кроме того, предусмотрено резервирование датчика температуры. В случае отказа датчика приточного воздуха (после нагревателя), контроллер автоматически переключится на датчик входящего (уличного воздуха) и скорость продолжит регулироваться по температурным лимитам. 
Данный алгоритм позволяет не только ограничивать расход энергии или воздуха в холодный период, но и снижать скорость вентилятора вплоть до полного его отключения, когда уровень CO2 в доме достигает заданной (как правило в случае отсутствия людей в вентилируемом помещении). Преимуществом данного алгоритма является простота настойки и оптимальная работа, которая позволяет поддерживать достаточно комфортный уровень CO2, достигая при этом максимальной энергоэффективности и не принося дискомфорта от излишних потоков холодного воздуха.

VI.	Логика управления контроллером.

Контроллер работает в двух основных режимах: ручной и автоматический (авторежим). По умолчанию контроллер загружается с включенным автоматическим режимом.
1.	Автоматический режим. Работает на основной логике, описанной в разделе V. Данный режим является основным, он активируется при загрузке контроллера, а также контроллер переходит в него при любых нештатных ситуациях.
2.	Ручной режим. Позволяет вручную устанавливать скорость, а также выключать вентилятор на неопределенное время, пока есть связь с Home Assistant. 
2.1.	Опция таймера. В ручном режиме у пользователя есть возможность установить таймер (в минутах) для перехода в авторежим. Это позволяет временно приостановить работу вентиляции или включить режим интенсивного проветривания на определенное время. После истечения времени контроллер перейдет в автоматический режим работы. Кнопка таймера не работает, когда активен авторежим.

VII.	Вспомогательная логика работы контроллера приточной вентиляции.

В связи с тем, что код контроллера разрабатывался под конкретные комплектующие, перечисленные в разделе III, потребовалась реализация дополнительной логики для обеспечения их работы:
1.	Преобразование диапазона управляющего напряжения из 0 – 10 вольт в 1.5 – 10 вольт. Связано с особенностью работы EC-вентилятора Dastech HDD-200PE, который работает при напряжении 1-1.5В. В связи с этим, в основном программном выходе реализовано соответствующее масштабирование напряжения, которое применяется на финальном этапе установки скорости. Данные параметры можно подстроить под свой вентилятор.
2.	Разгон вентилятора (speedup). EC-вентилятор Dastech HDD-200PE в соответствии с инструкцией должен запускаться при управляющем напряжении не ниже 3 вольт. Так как логика работы контроллера предполагает его запуск с низких скоростей (1% и выше) для корректного запуска вентилятора реализована логика разгона (speedup). При каждом запуске вентилятора скриптом активируется защитный период на 10 секунд. Если сразу при включении или в течении времени защитного периода была попытка установки скорости, соответствующей ниже 3В управляющего напряжения - автоматически активируется вспомогательный режим speedup. В режиме speedup принудительно устанавливается 3В управляющего напряжения на 10 секунд игнорируя в течении этого времени любые другие запросы скоростей в любых режимах. По истечении 10 секунд контроллер устанавливает последнюю запрошенную скорость и продолжает работу в текущем основном режиме (автоматическом, ручном или полуавтоматическом).
Данная логика гарантирует стабильный запуск приточного вентилятора с любых скоростей и должна быть полезна не только для конкретной модели Dastech HDD-200PE, но и для других моделей вентиляторов после корректировки продолжительности и управляющего напряжения в режиме разгона.
3.	Калибровочная таблица скоростей. В коде реализована калибровочная таблица для задания линейного соответствия процентов скорости по оборотам вентилятора. Так как расход воздуха почти напрямую зависит от количества оборотов вентилятора, пользователь может задать соответствие физических оборотов логическим процентам скорости. Для определения значений требуется тахометр (датчик оборотов) вентилятора (поддерживается в коде).
Пример: рабочие обороты вентилятора от 500 до 3500 RPM, конечные точки: 500 RPM – 1%, 3500 – 100% т.е. диапазон 3000 оборотов. Необходимо узнать промежуточные точки: в ручном режиме определить логический процент, который соответствует определенным оборотам. Для 10% оборотов определяем логический процент скорости на 800 RPM (500+300), например он будет 15% - следовательно в таблице задаем соответствие 15% -> 10%. И так далее, для оптимальной калибровки требуется 10-15 точек.
Если калибровочная таблица задана, устанавливаемый процент скорости будет точно соответствовать проценту от рабочего диапазона оборотов вентилятора, что должно обеспечить более линейный расход воздуха. Но данный функционал необязателен, и можно его не применять в работе. По умолчанию заданы 10 точек без данного преобразования.
Вышеописанная системная логика в коде собрана в едином скрипте apply_speed, который применяется при любом изменении скорости. Настройка параметров его работы под конкретный вентилятор задается в константах скрипта.

VIII.	Аварийный режим работы.

В контроллере предусмотрен аварийный режим для остановки вентиляции в случае неприемлемых показателей поступающего воздуха. В конкретном коде используется параметр концентрации дыма, отслеживаемый датчиком дыма MQ-2. Можно достаточно просто перепрофилировать режим под другой датчик, отслеживающий другие параметры или не использовать данный функционал. 
В оригинальной версии датчик MQ-2 передает уровень задымления в процентах. Так как аналоговый датчик требует точной калибровки и настройки под конкретные условия работы, реализован порог сработки аварийного режима, доступный для настройки из интерфейса Home Assistant.
При сработке предусмотрен гистерезис 10% - аварийный режим отменится после снижения уровня задымления на 10% ниже заданного. Для более эффективного отслеживания уровня дыма (или других соединений) в приточном канале после остановки вентиляции, предусмотрен режим периодической активации вентилятора с текущей скоростью автоматического режима каждые 20 минут на 30 секунд. Это позволяет эффективно обновить воздух в приточном канале и получить актуальные данные уровня загрязнения. Настроек периодичности и времени в Home Assistant не предусмотрено, так как это считается системный режимом, но их можно легко отредактировать напрямую в коде при необходимости.
Важно отметить, что данный режим работает только при активном Автоматическом режиме. Если до наступления события задымления Авторежим не был активен, то при активации аварийного режима автоматически активируется Авторежим и вентиляция отключится с периодическим проветриванием датчика. При этом в аварийном режиме у пользователя сохраняется возможность отключить авторежим и самостоятельно установить любую скорость на любое время или снова включить Авторежим. Логика аварийного режима продолжит работу, а в основном статусе работы контроллера отображение состояния Задымления останется в любом режиме, пока не произойдет автоматическая отмена по достижении нужных показателей качества воздуха. 
Так как сенсор MQ-2 требует качественной калибровки и отладки, для быстрого отключения аварийного режима предполагается установка порога в 100%. При этом сенсор MQ-2 ограничен показаниями 90%, таким образом при таком параметре аварийный режим никогда не будет активирован или немедленно отключится в случае неправильной активации. Так же необходимо обратить внимание на подключение MQ-2 к ESP32. Оптимальная точность работы достигается при питании датчика от 5 вольт. При этом необходимо подключать сигнальные провода к ESP через делитель, для согласования логических уровней 5В в 3.3В.

IX.	Экспериментальный функционал
В качестве эксперимента в контроллере реализован триггер отсутствия людей в доме, который при активации отключает нагреватель приточной системы и повышает скорость вентилятора для более быстрого проветривания. Это позволяет экономить расход электроэнергии и использовать ее дневной лимит позже в течении дня (при включенном лимите энергии). 
Данный триггер двухступенчатый и требует первичного сигнала отсутствия людей в доме от сервера Home Assistant:
1-ая ступень: сработка триггера отсутствия людей в доме по данным Home Assistant (например, отключились от wi-fi все смартфоны членов семьи, выключен ТВ, нет сработок от датчиков присутствия);
2-ая ступень: контроллер вентиляции при получении сигнала отсутствия людей по данным HA анализирует уровень CO2 в доме – если наблюдается устойчивое снижение в течении 5-10 минут – активирует основной триггер отсутствия.
При активном триггере:
- нагреватель блокируется (отключается);
- сенсор автоскорости принудительно переключается на скорость по CO2 минуя все ограничения с множителем 1,5 (на 50% выше);
- триггер сбрасывается по достижению скорости по CO2 = 0%
- триггер так же сбрасывается при получении сигнала присутствия людей по данным Home Assistant.
По умолчанию функционал умной вентиляции отключен. Если данный функционал не планируется к использованию можно удалить switch: и interval: относящийся к данному режиму из кода конфигурации контроллера.

X.	Логика работы системы подогрева
При наличии приточного нагревателя и связи с ним по Modbus, контроллер позволяет автоматически включать его и поддерживать заданную пользователем температуру. Для этого в контроллере реализован параметр целевой температуры приточного воздуха. Если температура после нагревателя окажется ниже заданной, контроллер автоматически включит нагреватель и будет поддерживать с помощью него заданную температуру.
Контроллер вентиляции принимает от нагревателя по Modbus следующие данные:
- температуру приточного воздуха (после подогрева);
- потребляемую электрическую мощность;
- текущий ток нагревателя;
- счетчик потребленной энергии;
- текущий режим нагревателя;
- флаги разрешения работы и перегрева нагревателя.
Контроллер вентиляции передает нагревателю по Modbus следующие данные:
- команды включения и отключения нагревателя;
- целевую температуру нагрева;
- сигнал сброса счетчика энергии (раз в сутки);
- текущие обороты с тахометра вентилятора (при наличии).
В системе нагревателя реализована необходимая защита для работы:
1.	Отключение при неработающем вентиляторе
2.	Отключение при перегреве.
3.	Отключение при отсутствии связи с основным контроллером по Modbus.
Подробнее логика работы нагревателя описана в разделе логики работы контроллера нагревателя приточной вентиляции.

XI.	Подробная инструкция по сборке контроллера содержится в папке docs. Видео по сборке доступно так же на YouTube: https://www.youtube.com/watch?v=NV509sOfitk

XII.	Дополнительная информация

Отказ от ответственности:
Данный проект системы вентиляции на базе ESPHome предоставляется и распространяется по принципу «как есть» (as-is), без каких-либо явных или подразумеваемых гарантий. Автор не гарантирует корректность работы, безопасность или пригодность решения для конкретных условий эксплуатации.
Использование материалов проекта осуществляется на ваш собственный риск. Вы самостоятельно несете ответственность за любые последствия, включая возможный ущерб оборудованию, имуществу или здоровью, возникшие в результате применения предложенных решений. Перед внедрением системы настоятельно рекомендуется:
•	провести аудит кода на соответствие стандартам безопасности;
•	протестировать решение в контролируемых условиях;
•	убедиться в соблюдении норм и правил эксплуатации инженерных систем.

Участие сообщества:
Автор приветствует любой вклад в развитие проекта, а также публикацию кода на площадке GitHub для совместного исправления ошибок, оптимизации кода, и реализации новых идей.

Благодарю за интерес к проекту!
